FROM git.x-project.com:4567/x-project/x-project-ci-image:app-image

ARG APP_PATH

ARG DATABASE_URL
ARG RAILS_ENV
ARG REDIS_URL
ARG S3_ACCESS_KEY_ID
ARG S3_BUCKET
ARG S3_REGION
ARG S3_SECRET_KEY
ARG SECRET_KEY_BASE
ARG WEBHOOKS_API_URL
ARG WIDGET_SRC

COPY --chown=app:app . ${APP_PATH}

ENV DATABASE_URL=${DATABASE_URL}
ENV RAILS_ENV=${RAILS_ENV}
ENV REDIS_URL=${REDIS_URL}
ENV S3_ACCESS_KEY_ID=${S3_ACCESS_KEY_ID}
ENV S3_BUCKET=${S3_BUCKET}
ENV S3_REGION=${S3_REGION}
ENV S3_SECRET_KEY=${S3_SECRET_KEY}
ENV SECRET_KEY_BASE=${SECRET_KEY_BASE}
ENV WEBHOOKS_API_URL=${WEBHOOKS_API_URL}
ENV WIDGET_SRC=${WIDGET_SRC}

RUN touch config/database.yml
RUN bundle install
RUN bundle exec rake assets:precompile
